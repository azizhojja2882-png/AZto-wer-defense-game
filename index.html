<script>
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');

let level=1;
let towers=[];
let enemies=[];
let bullets=[];
let gold=50;
let score=0;
let wave=0;

const levels=[
  [ {x:320,y:0},{x:320,y:200},{x:500,y:200},{x:500,y:480} ],
  [ {x:100,y:0},{x:100,y:150},{x:300,y:150},{x:300,y:300},{x:500,y:300},{x:500,y:480} ],
  [ {x:50,y:0},{x:50,y:200},{x:200,y:200},{x:200,y:100},{x:400,y:100},{x:400,y:250},{x:150,y:250},{x:150,y:400},{x:550,y:400},{x:550,y:480} ],
  [ {x:320,y:0},{x:320,y:480} ] // —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å —Å –±–æ—Å—Å–æ–º
];

let path=levels[level-1];

class Enemy{
  constructor(type="normal"){
    this.x=path[0].x;this.y=path[0].y;this.i=0;
    this.type=type;
    if(type==="normal"){this.hp=40;this.speed=1.2;this.color="red";}
    if(type==="fast"){this.hp=20;this.speed=2.2;this.color="orange";}
    if(type==="tank"){this.hp=80;this.speed=0.7;this.color="purple";}
    if(type==="boss"){this.hp=1000;this.speed=0.4;this.color="black";}
  }
  update(){
    const target=path[this.i+1];if(!target)return;
    const dx=target.x-this.x,dy=target.y-this.y,dist=Math.hypot(dx,dy);
    if(dist<this.speed){this.x=target.x;this.y=target.y;this.i++;}
    else{this.x+=this.speed*dx/dist;this.y+=this.speed*dy/dist;}
  }
  draw(){ctx.fillStyle=this.color;ctx.beginPath();ctx.arc(this.x,this.y,this.type==="boss"?30:10,0,Math.PI*2);ctx.fill();ctx.fillStyle='white';ctx.font='10px sans-serif';ctx.fillText(this.hp,this.x-10,this.y-14);}
}

class Tower{
  constructor(x,y){this.x=x;this.y=y;this.cd=0;this.level=1;}
  upgrade(){if(gold>=30){gold-=30;this.level++;}}
  update(){if(this.cd>0)this.cd--;else{
    let e=enemies.find(en=>Math.hypot(en.x-this.x,en.y-this.y)<100+this.level*20);
    if(e){bullets.push(new Bullet(this.x,this.y,e,this.level));this.cd=40-(this.level*5);if(this.cd<10)this.cd=10;
      document.getElementById("shootSound").play();
    }}
  }
  draw(){ctx.fillStyle='blue';ctx.beginPath();ctx.arc(this.x,this.y,14,0,Math.PI*2);ctx.fill();ctx.strokeStyle='white';ctx.beginPath();ctx.arc(this.x,this.y,100+this.level*20,0,Math.PI*2);ctx.stroke();ctx.fillStyle='yellow';ctx.fillText("Lv"+this.level,this.x-10,this.y-20);}
}

class Bullet{
  constructor(x,y,target,level){this.x=x;this.y=y;this.target=target;this.spd=4;this.dmg=10+level*5;}
  update(){if(!this.target)return;const dx=this.target.x-this.x,dy=this.target.y-this.y,dist=Math.hypot(dx,dy);if(dist<this.spd){this.hit();return;}this.x+=this.spd*dx/dist;this.y+=this.spd*dy/dist;}
  hit(){if(this.target)this.target.hp-=this.dmg;this.dead=true;}
  draw(){ctx.fillStyle='yellow';ctx.beginPath();ctx.arc(this.x,this.y,4,0,Math.PI*2);ctx.fill();}
}

canvas.addEventListener('click',e=>{
  const r=canvas.getBoundingClientRect();
  const x=e.clientX-r.left,y=e.clientY-r.top;
  let t=towers.find(t=>Math.hypot(t.x-x,t.y-y)<15);
  if(t){t.upgrade();return;}
  if(gold>=20){towers.push(new Tower(x,y));gold-=20;}
});

function startWave(){
  wave++;
  let type="normal";
  if(level==2) type="fast";
  if(level==3) type="tank";
  if(level==4 && wave==1){ type="boss"; enemies.push(new Enemy(type)); return; }
  for(let i=0;i<6+wave;i++){
    setTimeout(()=>{enemies.push(new Enemy(type));},i*700);
  }
}

document.getElementById('startBtn').onclick=startWave;

function nextLevel(){
  if(level<levels.length){
    level++;
    towers=[];enemies=[];bullets=[];gold=50;wave=0;
    path=levels[level-1];
    alert("–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å "+level);
  } else {
    alert("–í—ã –ø–æ–±–µ–¥–∏–ª–∏ –≤—Å–µ—Ö –≤—Ä–∞–≥–æ–≤, –≤–∫–ª—é—á–∞—è –ë–û–°–°–ê! üéâ");
  }
}

function update(){
  enemies.forEach(e=>e.update());
  towers.forEach(t=>t.update());
  bullets.forEach(b=>b.update());

  enemies=enemies.filter(e=>{
    if(e.hp<=0){score+=10;gold+=5;
      document.getElementById("explosionSound").play();
      if(e.type==="boss"){alert("–ë–æ—Å—Å –ø–æ–≤–µ—Ä–∂–µ–Ω! –ü–æ–±–µ–¥–∞!");nextLevel();}
      return false;}
    if(e.i>=path.length-1){score-=5;return false;}
    return true;
  });
  bullets=bullets.filter(b=>!b.dead);

  if(enemies.length===0 && wave>=3 && level<4){nextLevel();}
}

function draw(){
  ctx.fillStyle='#64748b';ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='black';ctx.lineWidth=6;ctx.beginPath();ctx.moveTo(path[0].x,path[0].y);
  for(let p of path.slice(1))ctx.lineTo(p.x,p.y);
  ctx.stroke();

  enemies.forEach(e=>e.draw());
  towers.forEach(t=>t.draw());
  bullets.forEach(b=>b.draw());

  document.getElementById('info').textContent=`–£—Ä–æ–≤–µ–Ω—å: ${level} | –û—á–∫–∏: ${score} | –ó–æ–ª–æ—Ç–æ: ${gold}`;
}

function loop(){update();draw();requestAnimationFrame(loop);}
loop();
</script>
